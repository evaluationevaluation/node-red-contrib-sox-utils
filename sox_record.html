<!--
  Copyright 2020, Johannes Kropf
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<script type="text/javascript">
    RED.nodes.registerType('sox-record',{
        category: 'Sox Utils',
        color: '#c28285',
        defaults: {
            name: {value:""},
            inputSource: {value:"alsa default", required:true},
            byteOrder: {value:"-L", required:true},
            encoding: {value:"signed-integer", required:true},
            channels: {value:1, required:true},
            rate: {value:16000, required:true},
            bits: {value:16, required:true},
            advancedSettings: {value:false, required:true},
            gain: {value:"0", required:true},
            highLowPass: {value:"n", required:true},
            highpass: {value:200, required:true},
            lowpass: {value:8000, required:true},
            showDuration: {value:false, required:true},
            durationType: {value:"forever", required:true},
            durationLength: {value:0, required:true},
            silenceDetection: {value:"nothing", required:true},
            silenceDuration: {value:"2.0", required:true},
            silenceThreshold: {value:"2.0", required:true},
            outputFormat: {value:"stream", required:true},
            debugOutput: {value:false, required:true}
        },
        inputs:1,
        outputs:2,
        icon: "font-awesome/fa-microphone",
        label: function() {
            return this.name||"sox-record";
        },
        oneditprepare: function() {
            var node = this;
            
            $("#node-input-durationType").on("change", function(){
                let durVar = $("#node-input-durationType").val();
                if(durVar == "limited"){
                    $("#durationLengthWrapper").show();
                } else {
                    $("#durationLengthWrapper").hide();
                }
            });
            
            $("#node-input-silenceDetection").on("change", function(){
                let silVar = $("#node-input-silenceDetection").val();
                if(silVar == "something"){
                    $("#silenceThresholdWrapper").show();
                    $("#silenceDurationWrapper").show();
                } else {
                    $("#silenceThresholdWrapper").hide();
                    $("#silenceDurationWrapper").hide();
                }
            });

            $("#node-input-highLowPass").on("change", function(){
                let passVar = $("#node-input-highLowPass").val();
                if(passVar == "n"){
                    $("#highpassWrapper").hide();
                    $("#lowpassWrapper").hide();
                } else if (passVar == "h") {
                    $("#highpassWrapper").show();
                    $("#lowpassWrapper").hide();
                } else if (passVar == "l") {
                    $("#highpassWrapper").hide();
                    $("#lowpassWrapper").show();
                } else if (passVar == "b") {
                    $("#highpassWrapper").show();
                    $("#lowpassWrapper").show();
                }
            });

            $("#node-input-showDuration").on("change", function(){
                if(!$("#node-input-showDuration").prop("checked")){
                    $("#durationOptionWrapper").hide();
                } else {
                    $("#durationOptionWrapper").show();
                }
            });

            $("#node-input-advancedSettings").on("change", function(){
                if(!$("#node-input-advancedSettings").prop("checked")){
                    $("#advancedSettingsWrapper").hide();
                } else {
                    $("#advancedSettingsWrapper").show();
                }
            });
        
        }
    });
</script>

<script type="text/html" data-template-name="sox-record">
    <h4>Source</h4>
    <div class="form-row">
        <label for="node-input-inputSource"><i class="icon-tag"></i>input source</label>
        <input type="text" id="node-input-inputSource" value="alsa default" />
    </div>
    <h4>Settings</h4>
    <div class="form-row">
        <label for="node-input-byteOrder"></i>byte order</label>
        <select id="node-input-byteOrder">
            <option value="-L">little endian</option> 
            <option value="-B">big endian</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-encoding"></i>encoding</label>
        <select id="node-input-encoding">
            <option value="signed-integer">signed-integer</option> 
            <option value="unsigned-integer">unsigned-integer</option>
            <option value="floating-point">floating-point</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-channels"><i class="icon-tag"></i>channels</label>
        <input type="number" id="node-input-channels" value="1" />
    </div>
    <div class="form-row">
        <label for="node-input-rate"><i class="icon-tag"></i>rate</label>
        <input type="number" id="node-input-rate" value="16000" />
    </div>
    <div class="form-row">
        <label for="node-input-bits"><i class="icon-tag"></i>bit-depth</label>
        <input type="number" id="node-input-bits" value="16" />
    </div>
    <div class="form-row">
        <label for="node-input-dvancedSettings">more</i></label>
        <input type="checkbox" id="node-input-advancedSettings" style="display:inline-block; width: auto; vertical-align:baseline;" value="false">
        <label for="node-input-advancedSettings" style="width: 70%;">show advanced settings</label>
    </div>
    <div id="advancedSettingsWrapper">
        <div class="form-row">
            <label for="node-input-gain"><i class="icon-tag"></i>gain in dB</label>
            <input type="text" id="node-input-gain" value="0" />
        </div>
        <div class="form-row">
            <label for="node-input-highLowPass"></i>add high-/lowpass</label>
            <select id="node-input-highLowPass">
                <option value="n">none</option>
                <option value="h">add highpass filter</option> 
                <option value="l">add lowpass filter</option>
                <option value="b">add high & lowpass filter</option>
            </select>
        </div>
        <div id="highpassWrapper" class="form-row">
            <label for="node-input-highpass"><i class="icon-tag"></i>highpass freq.</label>
            <input type="number" id="node-input-highpass" value="200" />
        </div>
        <div id="lowpassWrapper" class="form-row">
            <label for="node-input-lowpass"><i class="icon-tag"></i>lowpass freq.</label>
            <input type="number" id="node-input-lowpass" value="8000" />
        </div>
    </div>
    <h4>Recording Duration</h4>
    <div class="form-row">
        <label for="node-input-showDuration">duration</i></label>
        <input type="checkbox" id="node-input-showDuration" style="display:inline-block; width: auto; vertical-align:baseline;" value="false">
        <label for="node-input-showDuration" style="width: 70%;">show options</label>
    </div>
    <div id="durationOptionWrapper">
        <div class="form-row">
            <label for="node-input-durationType"><i class="icon-tag"></i>record time</label>
            <select id="node-input-durationType">
                <option value="forever">record until a stop msg is send</option> 
                <option value="limited">record for specified amount of seconds</option>
            </select>
        </div>
        <div id="durationLengthWrapper" class="form-row">
            <label for="node-input-durationLength"><i class="icon-tag"></i>seconds</label>
            <input type="number" id="node-input-durationLength" value="0" />
        </div>
        <div class="form-row">
            <label for="node-input-silenceDetection"><i class="icon-tag"></i>on silence</label>
            <select id="node-input-silenceDetection">
                <option value="nothing">do nothing</option> 
                <option value="something">stop recording</option>
            </select>
        </div>
        <div id="silenceDurationWrapper" class="form-row">
            <label for="node-input-silenceDuration"><i class="icon-tag"></i>below duration in s</label>
            <input type="text" id="node-input-silenceDuration" value="2.0" />
        </div>
        <div id="silenceThresholdWrapper" class="form-row">
            <label for="node-input-silenceThreshold"><i class="icon-tag"></i>below threshold in %</label>
            <input type="text" id="node-input-silenceThreshold" value="2.0" />
        </div>
    </div>
    <h4>Output</h4>
    <div class="form-row">
        <label for="node-input-outputFormat"></i>output format</label>
        <select id="node-input-outputFormat">
            <option value="stream">a stream of buffers while recording</option> 
            <option value="once">a single buffer when recording ends</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-debugOutput"></i>debug</label>
        <input type="checkbox" id="node-input-debugOutput" style="display:inline-block; width: auto; vertical-align:baseline;" value="false">
        <label for="node-input-debugOutput" style="width: 70%;">detailed debug info to 2nd output</label>
    </div>
    <h4>Name</h4>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>	
</script>

<script type="text/html" data-help-name="sox-record">
    <p>A simple wrapper node around the record functionality of the sox commandline utility. For detailed usage information please go to <a href="https://github.com/johanneskropf/node-red-contrib-sox-record">node-red-contrib-sox-record</a>.</p>
</script>